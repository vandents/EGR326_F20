/*
 * SevenSeg.c
 *
 *  Created on: Oct 30, 2020
 *      Author: scottvandentoorn
 */

#include "SevenSeg.h"



void SevenSeg_WriteInteger(uint8_t low_bit, uint8_t high_bit, uint16_t data) {
	int i, j = 1;
	for (i = low_bit; i <= high_bit; i++) {
		SevenSeg_Transmit(i + 1, SevenSeg_Decimal_to_BCD(data / j));
		j *= 10;
	}
}

void SevenSeg_Transmit(uint8_t address, uint8_t data) {
	P2->OUT &= ~0x20;	// CS LOW

	while(!(EUSCI_A1->IFG & 0x02));
	EUSCI_A1->TXBUF = address;

	while(EUSCI_A1->STATW & 0x01);
	EUSCI_A1->TXBUF = data;

	while(EUSCI_A1->STATW & 0x01);
	P2->OUT |= 0x20;	// CS HIGH
}

void SevenSeg_SPI_P2_Init(void) {
	/* UCA1 to SPI */
    EUSCI_A1->CTLW0 = 0x0001;	// Disable during config
	EUSCI_A1->CTLW0 = 0xA981;	// MSB, 8-bit, master, 3-pin, synch, SMCLK
	EUSCI_A1->BRW = 2;			// 12MHz / 2 = 6 MHz clock
	EUSCI_A1->CTLW0 &= ~0x0001;	// Enable

	/* Unlock PMAP */
    PMAP->KEYID = 0x2D52;

	/* DIN and CLK pins */
    P2MAP->PMAP_REGISTER[1] = 0x0800;	// Map P2.3 to PM_UCA1CLK
    P2MAP->PMAP_REGISTER[2] = 0x070A;	// Map P2.4 to PM_UCA1SIMO
	P2->SEL0 |= 0x18;
	P2->SEL1 &= ~0x18;			// P2.3 - 2.4 pin function to UCB3

    /* CS pin */
	P2->SEL0 &= ~0x20;
	P2->SEL1 &= ~0x20;			// P2.5 to GPIO
    P2->DIR |= 0x20;			// P2.5 to Output
    P2->OUT |= 0x20;			// P2.5 to Output HIGH

    /* Lock PMAP */
    PMAP->CTL = 0;
    PMAP->KEYID = 0;
}

/**
 * @param d A Decimal number
 * @return Corresponding binary-coded decimal
 */
unsigned char SevenSeg_Decimal_to_BCD(unsigned char d) {
	return (((d / 10) << 4) & 0xF0) | ((d % 10) & 0x0F);
}
